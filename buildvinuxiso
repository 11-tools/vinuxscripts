#!/bin/bash
#
# This script will build a remaster of the installed system, it
# should run after the buildvinux script. To run it type:
# 'sudo buildvinuxiso'. It will remove some applications so 
# the ISO fits on a CD, and it make some other changes
# to the system.
#
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 0 - Declare text colour/system bell functions

function black {
    tput setf 0   
}

function green {
    tput setf 2    
}

function blue {
    tput setf 3
}

function red {
    tput setf 4    
}

function white {
    tput setf 7
}

function reset {
    tput reset
}

function bell {
    echo -en "\007"    
}

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 1 - Specify Release Version

echo
bell
red
echo -n "Enter the release number, for example 3.0-Beta-1.0: "; read RELEASE
green
echo

RELEASE_SPACES=`echo $RELEASE | sed 's/-/ /g'`

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 2 - Remove Applications

echo
bell
red
echo -n "Do you want to remove packages to fit the iso onto a CD? [y/n]: "
read ANSWER
green
echo

if [ "$ANSWER" = "y" ]; then  

echo
blue
echo "Removing applications to make room on the CD"
green
echo

apt-get  purge -y -qq openoffice.org* libreoffice* gbrainy evolution-common evolution-data-server f-spot ttf-unfonts-core ttf-thai-tlwg ttf-wqy-microhei ttf-punjabi-fonts ttf-lao ttf-kacst-one festival samba-common samba-common-bin smbclient ure festlex-cmu festlex-poslex festvox-kallpc16k nautilus-share gnome-user-guide fluxbox bbtime bbrun debian-installer-launcher debian-installer libqtgui4 unetbootin tomboy gtodo libopal3.6.8 foomatic-db oxygen-icon-theme kdebase-runtime-data kdelibs5-data libkdecore5 libkdesu5 gnome-themes-more libgl1-mesa-dri* virtuoso-opensource-6.1-bin speechd-up
apt-get autoremove -y -qq
apt-get clean

echo Cleaning up /root home directory before remastersys, nano history, bash_history, wajig and aptitude. 
rm -f /root/.nano_history
rm -f /root/.bash_history
rm -rf /root/.wajig
rm -rf /root/.aptitude
rm -rf /root/.ssh

# Add EasyInstall to /etc/skel
rsync -r /usr/share/vinux/EasyInstall_skel/ /etc/skel
chmod -R a+r /etc/skel

#Enable grub beep
echo Enabling pc speaker beep at Grub boot menu.
sed -i '/^#GRUB_INIT_TUNE=/s/^#//' /etc/default/grub

echo branding Vinux console
sudo echo "Vinux $RELEASE_SPACES \n \l" > /etc/issue
fi

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 3 - Configure Remastersys

echo
blue
echo "Configuring remastersys..."
green
echo

# Run remastersys and change the username to 'vinux' and the name of the
# CD and ISO file to the Vinux RELEASE name specified above (.iso)
sed -i "s/LIVEUSER=.*/LIVEUSER=\"vinux\"/
        s/LIVECDLABEL=.*/LIVECDLABEL=\"Vinux $RELEASE_SPACES\"/
        s/CUSTOMISO=.*/CUSTOMISO=\"Vinux-$RELEASE.iso\"/" /etc/remastersys.conf

# copy modified isolinux.cfg.vesamenu

cp -f /usr/share/vinux/isolinux.cfg.vesamenu /etc/remastersys/isolinux/isolinux.cfg.vesamenu

# Set timeout and accessibility mode
# sed -i 's/^timeout.*/timeout 100/
   # s/^prompt.*/prompt 0\nnoescape 1/
   # s/ access=v3//
   # s/boot=casper/boot=casper access=v3/' /etc/remastersys/isolinux/isolinux.cfg.vesamenu

# Change boot background

cp -f /usr/share/vinux/images/splash.png /etc/remastersys/isolinux/splash.png

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 4 - Build Iso

# Clean remastersys first from previous builds
echo Clean up previous remastersys

remastersys clean

# Run remastersys in 'dist' mode from the Menu Launcher or the terminal. 
# The iso should be in /home/remastersys in about 5 to 20 minutes depending on your computers speed.

echo
blue
echo "Building ISO..."
green
echo
remastersys dist

