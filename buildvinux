#!/bin/bash
# This should be run after doing the following instructions.  After that, your system should be
# identical to Vinux/Lucid.  Note that you only use 'vinux' as the user name if you plan to
# create a Vinux ISO.  This script can also be used to restore your speech if your system
# stops talking after an upgrade.
#
# 1. Download the Ubuntu Lucid Alpha 3 i386 iso and burn it to CD.
#
# 2. Boot from the CD, Press F5, select 'screen-reader' and boot the live CD.
#
# 3. Run the Ubuntu Installer, install the system to hard drive using 'vinux' as the username and
# password, then reboot.

# Ask this first, so the user doesn't have to wait around listening carefully.
echo "Please enter your zipcode for Stormdragon's weather reporting using Orca+w"
read zipCode

# Update /etc/apt/sources.list
egrep -v 'vinux|remastersys' /etc/apt/sources.list > /tmp/vinux.tmp
echo '# Repositories supporting vinux packages.
deb http://ppa.launchpad.net/vinux/vinux-lucid/ubuntu lucid main
deb-src http://ppa.launchpad.net/vinux/vinux-lucid/ubuntu lucid main
deb http://ppa.launchpad.net/vinux/vinux-karmic/ubuntu karmic main
deb-src http://ppa.launchpad.net/vinux/vinux-karmic/ubuntu karmic main
deb http://www.geekconnection.org/remastersys/repository karmic/' >> /tmp/vinux.tmp
sed -i 's/^# *deb\(.*\) partner *$/deb\1 partner/
    s/^# *deb\(.*\)backports\(.*\)$/deb\1backports\2/' /tmp/vinux.tmp
sudo mv /tmp/vinux.tmp /etc/apt/sources.list

# Import the Vinux/Ubuntu Team repository key.
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys EF2AFDCF > buildvinux.log 2>&1

# Update to the latest packages.
echo "Updating package list..."
sudo apt-get update > buildvinux.log
echo "Upgrading all packages... This can take a long time.  See buildvinux.log for progress"
sudo apt-get dist-upgrade -y >> buildvinux.log

# Set pulseaudio to run as system-wide daemon.
echo "Setting pulseaudio to run system-wide"
sudo sed -i 's/PULSEAUDIO_SYSTEM_START=0/PULSEAUDIO_SYSTEM_START=1/' /etc/default/pulseaudio
sudo sed -i 's/^ *; *autospawn *= *yes *$/autospawn = no/' /etc/pulse/client.conf
sudo rm -f /etc/xdg/autostart/pulseaudio.desktop
sudo sed -i 's/^OnlyShowIn=XFCE;$/OnlyShowIn=GNOME;XFCE;/' /etc/xdg/autostart/gnome-volume-control-applet.desktop
sudo sed -i 's/load-module module-native-protocol-unix$/load-module module-native-protocol-unix auth-anonymous=1/' /etc/pulse/system.pa

# Enable talking login window
echo "Enabling talking login screen"
sudo -u gdm gconftool-2 -s -t bool /desktop/gnome/interface/accessibility true
sudo -u gdm gconftool-2 -s -t bool /desktop/gnome/applications/at/visual/startup true
sudo -u gdm gconftool-2 -s -t string /desktop/gnome/applications/at/visual/exec orca
sudo -u gdm gconftool-2 -s -t bool /desktop/gnome/applications/at/screen_reader_enabled true

# Install some packages
sudo apt-get install -y speakup-source speakup-tools module-assistant remastersys runsu gparted yasr compizconfig-settings-manager speech-dispatcher-voxin >> buildvinux.log

# Rebuild speakup from source
echo "Rebuilding speakup from source.  This can take a minute or so."
sudo m-a a-i -f speakup-source -q > buildvinux.log 2>&1
sudo modprobe speakup_soft

# Enable speech-dispatcher to run system-wide
sudo sed -i 's/RUN_SPEECHD=no/RUN_SPEECHD=yes/' /etc/default/speech-dispatcher

# Install speechd-up
sudo /etc/init.d/speechd-up stop >> buildvinux.log
sudo apt-get install -y speechd-up >> buildvinux.log

# Edit speechd.conf to enable ibmtts.
sudo sed -i 's/#AddModule "ibmtts"/#AddModule "ibmtts"/' /etc/speech-dispatcher/speechd.conf
sed -i 's/#AddModule "ibmtts"/#AddModule "ibmtts"/' ~/.speech-dispatcher/conf/speechd.conf

# Change menus to use runsu instead of gksu
echo "Updating main menu"
cp vinux_data/menus/* ~/.local/share/applications

# Update Orca
rm -rf ~/.orca
cp -a vinux_data/orca ~/.orca
if [ "$zipCode" != "" ]; then
    sed -i 's/zipCode = "[0-9]*"/zipCode = "'$zipCode'"/' ~/.orca/orca-customizations.py
fi

# Set Vinux keybindings
echo "Setting Vinux keybindings"
function add-keybinding {
    gconftool-2 -s -t string "$1" "$2"
}

add-keybinding /apps/gnome_settings_daemon/keybindings/volume_mute '<Shift><Control>m'
add-keybinding /apps/gnome_settings_daemon/keybindings/search '<Shift><Control>s'
add-keybinding /apps/gnome_settings_daemon/keybindings/home '<Shift><Control>h'
add-keybinding /apps/gnome_settings_daemon/keybindings/www '<Shift><Control>w'
add-keybinding /apps/gnome_settings_daemon/keybindings/email '<Shift><Control>e'
add-keybinding /apps/gnome_settings_daemon/keybindings/calculator '<Shift><Control>c'
add-keybinding /apps/gnome_settings_daemon/keybindings/volume_up '<Shift><Control>Up'
add-keybinding /apps/gnome_settings_daemon/keybindings/volume_down '<Shift><Control>Down'
add-keybinding /apps/metacity/global_keybindings/run_command_terminal '<Shift><Control>t'
add-keybinding /apps/metacity/window_keybindings/maximize_horizontally '<Shift><Control>z'
add-keybinding /apps/metacity/window_keybindings/maximize_vertically '<Shift><Control>v'
add-keybinding /apps/metacity/window_keybindings/toggle_maximized '<Shift><Control>x'
add-keybinding /apps/metacity/window_keybindings/toggle_fullscreen '<Shift><Control>f'

# takes custom key number, name, binding, and action in that order
function add-customkey {
    gconftool-2 -s -t string /desktop/gnome/keybindings/custom$1/action "$4"
    gconftool-2 -s -t string /desktop/gnome/keybindings/custom$1/name "$2"
    gconftool-2 -s -t string /desktop/gnome/keybindings/custom$1/binding "$3"
}

add-customkey 0 'Orca Restart' '<Shift><Control>o' 'sh -c "killall speech-dispatcher; orca --replace"'
add-customkey 1 'Gedit' '<Shift><Control>g' 'gedit'
add-customkey 2 'Rhythmbox' '<Shift><Control>r' 'rhythmbox'
add-customkey 3 'Dictionary' '<Shift><Control>d' 'gnome-dictionary'
add-customkey 4 'Brasero' '<Shift><Control>b' 'brasero'
add-customkey 5 'Metacity' '<Shift><Control>F2' 'metacity --replace'
add-customkey 6	'Compiz' '<Shift><Control>F3' 'compiz --replace'
add-customkey 7	'Root Nautilus' '<Shift><Control>n' 'runsu nautilus'
add-customkey 8	'YASR' '<Shift><Control>y' 'gnome-terminal -e yasr'

# Compiz
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/zoom_in_button '<Super><Button1>'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/zoom_out_button '<Super><Button3>'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/zoom_specific_1_key '<Super>1'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/zoom_specific_2_key '<Super>2'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/zoom_specific_3_key '<Super>3'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/lock_zoom_key '<Super>l'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/pan_left_key '<Super>Left'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/pan_right_key '<Super>Right'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/pan_up_key '<Super>Up'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/pan_down_key '<Super>Down'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/fit_to_zoom_key '<Super>r'
add-keybinding /apps/compiz/plugins/ezoom/allscreens/options/fit_to_window_key '<Super>z'
gconftool-2 -s -t bool /apps/compiz/plugins/ezoom/screen0/options/hide_original_mouse true
gconftool-2 -s -t bool /apps/compiz/plugins/ezoom/screen0/options/scale_mouse true
add-keybinding /apps/compiz/plugins/neg/allscreens/options/screen_toggle_key '<Super>s'
add-keybinding /apps/compiz/plugins/mag/allscreens/options/zoom_in_button '<Shift><Super>Button1'
add-keybinding /apps/compiz/plugins/mag/allscreens/options/zoom_out_button '<Shift><Super>Button3'
gconftool-2 -s -t int /apps/compiz/plugins/ezoom/screen0/options/box_width 640
gconftool-2 -s -t int /apps/compiz/plugins/ezoom/screen0/options/box_height 480
add-keybinding /apps/compiz/plugins/obs/allscreens/options/brightness_increase_key '<Super>b'
add-keybinding /apps/compiz/plugins/obs/allscreens/options/brightness_decrease_key '<Super>v'
add-keybinding /apps/compiz/plugins/obs/allscreens/options/saturation_increase_key '<Super>t'
add-keybinding /apps/compiz/plugins/obs/allscreens/options/saturation_decrease_key '<Super>y'
add-keybinding /apps/compiz/plugins/switcher/allscreens/options/next_all_key 'Disabled'
add-keybinding /apps/compiz/plugins/switcher/allscreens/options/next_panel_key '<Control><Alt><Tab>'
add-keybinding /apps/compiz/plugins/switcher/allscreens/options/prev_all_key 'Disabled'
add-keybinding /apps/compiz/plugins/switcher/allscreens/options/prev_panel_key '<Shift><Control><Alt><Tab>'

# Now disable/enable compiz plugins
function set_list {
    list=`gconftool-2 -g $1`
    value=`echo $list | egrep "(,|\[)$2(,|\])"`
    if [ "$value" = "" ]; then
        list=`echo $list | sed "s/\]/,$2\]/"`
        gconftool-2 -s -t list --list-type string $1 $list
    fi
}

function unset_list {
    list=`gconftool-2 -g $1`
    value=`echo $list | egrep "(,|\[)$2(,|\])"`
    if [ "$value" != "" ]; then
        list=`echo $list | sed "s/,$2,/,/
            s/,$2\]/\]/
            s/\[$2,/\[/
            s/\[$2\]/\[\]/"`
        gconftool-2 -s -t list --list-type string $1 $list
    fi
}

unset_list /apps/compiz/general/allscreens/options/active_plugins staticswitcher
set_list /apps/compiz/general/allscreens/options/active_plugins switcher
set_list /apps/compiz/general/allscreens/options/active_plugins mag

echo "Done!  Enjoy your new Vinux-like environment."
echo "Please report bugs to vinux-development@googlegroups.com"
