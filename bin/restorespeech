#!/bin/bash
#
# This script can be run anytime to restore speech to a working state on a system.  
# type: 'sudo restorespeech'.
#
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 0 - Declare text colour/system bell functions

function black {
    tput setf 0   
}

function green {
    tput setf 2    
}

function blue {
    tput setf 3
}

function red {
    tput setf 4    
}

function white {
    tput setf 7
}

function reset {
    tput reset
}

function bell {
    echo -en "\007"    
}

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

# Stage 1 - Configure PulseAudio

# Set pulseaudio to run as system-wide daemon.
echo
blue
echo "Setting pulseaudio to run system-wide..."
green
echo

sed -i 's/PULSEAUDIO_SYSTEM_START=0/PULSEAUDIO_SYSTEM_START=1/' /etc/default/pulseaudio
sed -i 's/^ *; *autospawn *= *yes *$/autospawn = no/' /etc/pulse/client.conf
rm -f /etc/xdg/autostart/pulseaudio.desktop
sed -i 's/^OnlyShowIn=XFCE;$/OnlyShowIn=GNOME;XFCE;/' /etc/xdg/autostart/gnome-volume-control-applet.desktop
sed -i 's/load-module module-native-protocol-unix$/load-module module-native-protocol-unix auth-anonymous=1/' /etc/pulse/system.pa

# Changed pulseaudio start dependencies so it starts
# earlier, depends on speech-dispatcher
sed -i 's/# Should-Start:      udev NetworkManager/# Should-Start:      udev NetworkManager speech-dispatcher/' /etc/init.d/pulseaudio 
sed -i 's/# Should-Stop:       udev NetworkManager/# Should-Stop:       udev NetworkManager speech-dispatcher/' /etc/init.d/pulseaudio 

# force update-rc.d to rebuild pulseaudio runlvel scripts
update-rc.d -f pulseaudio remove && update-rc.d pulseaudio defaults

# Stage 2 - Configuring Speech

echo
blue
green
echo

# Enable speakup

if [ "`grep 'speakup_soft start=1' /etc/modules`" = "" ]; then
modprobe speakup_soft start=1
echo "speakup_soft start=1" >> /etc/modules
fi

echo
blue
echo "Setting up speech packages..."
green
echo

# Install speechd-up
if [ -f /etc/init.d/speechd-up ]; then
    /etc/init.d/speechd-up stop 
fi
apt-get install -y -qq speechd-up 

# Stage 3 - Activate volume control applet

sed -i 's/^OnlyShowIn=XFCE;$/OnlyShowIn=GNOME;XFCE;/' /etc/xdg/autostart/gnome-volume-control-applet.desktop

# Stage 4 - Enable brltty for Braille displays
sed -i 's/^RUN_BRLTTY=.*/RUN_BRLTTY=yes/' /etc/default/brltty

